<!--
 *  Copyright (c) 2015 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
-->
<!-- A test suite is a composition of many tests. -->
<dom-module id="testrtc-suite">
  <style>
    paper-toolbar.test-suite {
      margin-top: 1.5em;
      cursor: pointer;
      color: #000;
    }
    .title {
      margin-left: 0px;
    }

    .header {
      background-color: #e2e2e2;
    }

    :host[state='success'] .header {
      background-color: #90ec90;
    }
    :host[state='success'] iron-icon {
      color: #080;
    }

    :host[state='warning'] .header {
      background-color: #ecec90;
    }

    :host[state='failure'] .header {
      background-color: #ec9090;
    }
    :host[state='failure'] iron-icon {
      color: #F00;
    }

    .header {
      margin-top: 30px;
      height: 64px;
      display: flex;
      padding-left: 16px;
      padding-right: 16px;
      align-items: center;
      cursor: pointer;
    }

    .header .title {
      flex: 1;
      font-weight: 300;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #collapse {
      background-color: #f4f4f4;
    }
  </style>
  <template>
    <div class="header" on-tap="toggle">
      <span class="title">{{name}}</span>
      <iron-icon icon="[[_iconForState(state)]]"></iron-icon>
    </div>
    <iron-collapse id="collapse" opened="{{opened}}"></iron-collapse>
  </template>
  <script>
    Polymer({
      is: 'testrtc-suite',
      properties: {
        state: {
          value: 'pending',
          reflectToAttribute: true
        },
        tests: {
          type: Array,
          value: function() { return []; }
        }
      },
      _iconForState: function (state) {
        if (state === 'failure') { return 'close'; }
        if (state === 'warning') { return 'check'; }
        if (state === 'success') { return 'check'; }
        if (state === 'running') { return 'more-horiz'; }
        return '';
      },
      toggle: function() {
        this.$.collapse.toggle();
      },
      addTest: function(testName, testFunction) {
        var test = document.createElement('testrtc-test');
        test.name = testName;
        test.testFunction = testFunction;
        Polymer.dom(this.$.collapse).appendChild(test);
        this.tests.push(test);
      },
      run: function(doneCallback) {
        this.opened = true;
        this.state = 'running';
        runAllSequentially(this.tests, this.allTestFinished.bind(this,
                                                                 doneCallback));
      },
      allTestFinished: function(doneCallback) {
        var errors = 0;
        var warnings = 0;
        var successes = 0;
        for (var i = 0; i !== this.tests.length; ++i) {
          errors += this.tests[i].errorCount;
          warnings += this.tests[i].warningCount;
          successes += this.tests[i].successCount;
        }

        if (errors === 0 && warnings === 0 && successes > 0) {
          this.state = 'success';
          this.opened = false;
        } else if (errors === 0 && warnings > 0) {
          this.state = 'warning';
          this.opened = false;
        } else {
          this.state = 'failure';
          this.opened = true;
        }
        doneCallback();
      }
    });
  </script>
</dom-module>

