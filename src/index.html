<!--
 *  Copyright (c) 2014 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
-->
<!DOCTYPE html>
<html>
<head>
  <meta name="keywords" content="WebRTC, HTML5, JavaScript" />
  <meta name="description" content="Client-side WebRTC code samples." />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <base target="_blank">
  <title>WebRTC Troubleshooter</title>

  <link rel="icon" type="image/png" href="/images/webrtc-icon-192x192.png" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700">

  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48530561-3', 'auto');
    ga('send', 'pageview');
  </script>

  <script src="../components/webrtc-adapter/adapter.js"></script>
  <script src="components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../components/polymer/polymer.html"></script>
  <link rel="import" href="../components/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="../components/iron-icon/iron-icon.html">
  <link rel="import" href="../components/iron-icons/iron-icons.html">
  <link rel="import" href="../components/iron-icons/av-icons.html">
  <link rel="import" href="../components/iron-collapse/iron-collapse.html">
  <link rel="import" href="../components/paper-dialog/paper-dialog.html">
  <link rel="import" href="../components/paper-progress/paper-progress.html">
  <link rel="import" href="../components/paper-button/paper-button.html">
  <link rel="import" href="../components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="ui/gum-dialog.html">
  <link rel="import" href="ui/report-dialog.html">

  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/main_nolint.css" />

  <style is="custom-style">
    * {
      --paper-toolbar-background: #4F7DC9;
      --paper-toolbar-color: #FFF; 
    }
  </style>

</head>
<body unresolved>
  <dom-module id="testrtc-main">
    <template>
      <gum-dialog heading="Welcome to WebRTC Troubleshooter" pending="{{pending}}"></gum-dialog>

      <!-- Title toolbar -->
      <paper-toolbar class="titlebar">
        <span class="title">WebRTC Troubleshooter</span>
        <paper-icon-button icon="menu" on-tap="openSettingsDialog"></paper-icon-button>
        <paper-icon-button icon="bug-report" on-tap="openBugReport"></paper-icon-button>
        <paper-button id="startButton" on-tap="run" raised disabled>Start</paper-button>
      </paper-toolbar>

      <!-- Settings dialog -->
      <paper-dialog id="settings">
        <h2>Settings</h2>
        <div class="select"><label>Audio source: <select id="audioSource"></select></label></div>
        <div class="select"><label>Video source: <select id="videoSource"></select></label></div>
      </paper-dialog>

      <!-- Bug report dialog -->
      <report-dialog id="bugreport"></report-dialog>
    </template>
    <script>
      Polymer({
        is: 'testrtc-main',
        observers: [
          '_pendingChanged(pending)'
        ],
        _pendingChanged: function (pending) {
          if (pending === false) {
            // Populate the device selection drop down menu after the gUM dialog closes.
            navigator.mediaDevices.enumerateDevices()
            .then(this.gotSources.bind(this))
            .catch(function(err) {
              console.log('JS Device selection not supported', err);
            });

            window.doGetUserMedia = this.doGetUserMedia.bind(this);
            this.$.startButton.removeAttribute('disabled');
          }
        },
        gotSources: function(sourceInfos) {
          for (var i = 0; i !== sourceInfos.length; ++i) {
            var sourceInfo = sourceInfos[i];
            var option = document.createElement('option');
            option.value = sourceInfo.deviceId;
            this.appendOption(sourceInfo, option);
          }
        },
        appendOption: function (sourceInfo, option) {
          if (sourceInfo.kind === 'audioinput') {
            option.text = sourceInfo.label || 'microphone ' + (this.$.audioSource.length + 1);
            this.$.audioSource.appendChild(option);
          } else if (sourceInfo.kind === 'videoinput') {
            option.text = sourceInfo.label || 'camera ' + (this.$.videoSource.length + 1);
            this.$.videoSource.appendChild(option);
          } else {
            console.log('Some other kind of source');
          }
        },

        doGetUserMedia: function(constraints, onSuccess, onFail) {
          var self = this;
          var traceGumEvent = report.traceEventAsync('getusermedia');

          // Call into getUserMedia via the polyfill (adapter.js).
          var successFunc = function(stream) {
            var cam = self.getDeviceName_(stream.getVideoTracks());
            var mic = self.getDeviceName_(stream.getAudioTracks());
            traceGumEvent({'status': 'success', 'camera': cam, 'microphone': mic});
            onSuccess.apply(this, arguments);
          };
          var failFunc = function(error) {
            traceGumEvent({'status': 'fail', 'error': error});
            if (onFail) {
              onFail.apply(this, arguments);
            } else {
              reportFatal('Failed to get access to local media due to error: ' +
                          error.name);
            }
          };
          try {
            // Append the constraints with the getSource constraints.
            this.appendSourceId(this.$.audioSource.value, 'audio', constraints);
            this.appendSourceId(this.$.videoSource.value, 'video', constraints);

            traceGumEvent({'status': 'pending', 'constraints': constraints});
            getUserMedia(constraints, successFunc, failFunc);
          } catch (e) {
            console.log(e);
            traceGumEvent({'status': 'exception', 'error': e.message});
            return reportFatal('getUserMedia failed with exception: ' + e.message);
          }
        },

        appendSourceId: function(id, type, constraints) {
          if (constraints[type] === true) {
            constraints[type] = {optional: [{sourceId: id}]};
          } else if (typeof constraints[type] === 'object') {
            if (typeof constraints[type].optional === 'undefined') {
              constraints[type].optional = [];
            }
            constraints[type].optional.push({sourceId: id});
          }
        },

        // Return the first device label on the track.
        getDeviceName_: function(tracks) {
          if (tracks.length === 0) {
            return null;
          }
          return tracks[0].label;
        },

        run: function() {
          var self = this;
          this.$.startButton.setAttribute('disabled', null);
          runAllSequentially(testSuites, function() {
            self.$.startButton.removeAttribute('disabled');
          });
        },
        openBugReport: function() { this.$.bugreport.open(); },
        openSettingsDialog: function() { this.$.settings.open(); }
      });
    </script>
  </dom-module>

  <testrtc-main></testrtc-main>

  <!-- Placeholder for dynamically generated test suites. -->
  <div id="content"></div>

  <footer>
    <span><a href="//www.google.com/accounts/TOS">Terms</a></span>
    <span><a href="//www.google.com/policies/privacy/">Privacy</a></span>
  </footer>

  <script src="js/main.js"></script>
  <script src="js/call.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/ssim.js"></script>
  <script src="js/util.js"></script>

  <!-- Add tests after this line. -->
  <script src="js/mictest.js"></script>
  <script src="js/camresolutionstest.js"></script>
  <script src="js/conntest.js"></script>
  <script src="js/bandwidth_test.js"></script>
</body>
</html>
